<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>ch.vd.formation.lagapep</groupId>
        <artifactId>lagapep-root</artifactId>
        <version>13.7.0-SNAPSHOT</version>
    </parent>

    <artifactId>lagapep-app</artifactId>
    <name>Lagapep - Application</name>
    <description>Lagapep Application</description>
    <packaging>${app-packaging}</packaging>

    <properties>
        <com.oracle.jdbc.ojdbc10.version>19.7.0.0</com.oracle.jdbc.ojdbc10.version>
        <maven.deploy.skip>false</maven.deploy.skip>
        <maven.source.skip>true</maven.source.skip>
    </properties>

    <dependencies>
        <!-- Lagapep modules -->
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-entreprise</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-esb-core</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-etablissement</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-person</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-profession</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-territory</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-security-core</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-user</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-template-document</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-document-generation</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-document-store</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-indicator</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>${project.groupId}</groupId>
            <artifactId>lagapep-bdfa2-core</artifactId>
            <version>${project.version}</version>
        </dependency>

        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-activemq</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-sleuth</artifactId>
        </dependency>

        <!-- Atomikos -->
        <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>transactions-spring-boot-starter</artifactId>
        </dependency>

        <!-- Oracle -->
        <dependency>
            <groupId>com.oracle.database.jdbc</groupId>
            <artifactId>ojdbc10</artifactId>
            <version>${com.oracle.jdbc.ojdbc10.version}</version>
        </dependency>

        <!-- ActiveMQ -->
        <dependency>
            <groupId>org.apache.activemq</groupId>
            <artifactId>activemq-broker</artifactId>
        </dependency>

        <!-- Liquibase -->
        <dependency>
            <groupId>org.liquibase</groupId>
            <artifactId>liquibase-core</artifactId>
        </dependency>

        <!-- Hazelcast -->
        <dependency>
            <groupId>com.hazelcast</groupId>
            <artifactId>hazelcast-spring</artifactId>
        </dependency>

        <!-- Utils -->
        <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
        </dependency>

        <!-- Tests -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <profiles>
        <profile>
            <id>DGNSI</id>
            <activation>
                <activeByDefault>true</activeByDefault>
            </activation>
            <properties>
                <app-packaging>jar</app-packaging>
                <start-class>ch.vd.formation.lagapep.LagapepApplication</start-class>

                <!-- ACV/DGNSI - Angular resources packaging properties -->
                <front.dist>${project.parent.basedir}/front/dist</front.dist>
                <front.dist.package.outputDirectory>fe-lagapep</front.dist.package.outputDirectory>

                <target.classes>target/classes</target.classes>
                <target.classes.publicOrStatic>public</target.classes.publicOrStatic>

                <!-- ACV/DGNSI - Assembly build properties -->
                <assembly.finalName>${devex-maven-plugin.deployUnit}-${project.version}</assembly.finalName>
                <executable.finalName>${devex-maven-plugin.deployUnit}</executable.finalName>
            </properties>
            <dependencies>
                <!-- Lagapep modules -->
                <dependency>
                    <groupId>${project.groupId}</groupId>
                    <artifactId>lagapep-front</artifactId>
                    <version>${project.version}</version>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-resources-plugin</artifactId>
                        <configuration>
                            <encoding>${project.build.sourceEncoding}</encoding>
                        </configuration>
                        <executions>
                            <execution>
                                <id>exec-copy-angular-resources</id>
                                <phase>prepare-package</phase>
                                <goals>
                                    <goal>copy-resources</goal>
                                </goals>
                                <configuration>
                                    <outputDirectory>
                                        ${basedir}/${target.classes}/${target.classes.publicOrStatic}
                                    </outputDirectory>
                                    <resources>
                                        <resource>
                                            <directory>${front.dist}/${front.dist.package.outputDirectory}</directory>
                                            <filtering>false</filtering>
                                        </resource>
                                    </resources>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>ELCA</id>
            <activation>
                <activeByDefault>false</activeByDefault>
            </activation>
            <properties>
                <app-packaging>jar</app-packaging>
                <start-class>ch.vd.formation.lagapep.LagapepApplication</start-class>
                <!-- Assembly build properties -->
                <assembly.finalName>${devex-maven-plugin.deployUnit}-${project.version}</assembly.finalName>
                <executable.finalName>${devex-maven-plugin.deployUnit}</executable.finalName>
            </properties>
            <build>
                <resources>
                    <resource>
                        <directory>src/main/resources</directory>
                        <filtering>true</filtering>
                        <includes>
                            <include>logging/logback-spring.xml</include>
                        </includes>
                    </resource>
                </resources>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-dependency-plugin</artifactId>
                        <version>3.2.0</version>
                        <executions>
                            <execution>
                                <id>unpack-glowroot</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>unpack</goal>
                                </goals>
                                <configuration>
                                    <artifactItems>
                                        <artifactItem>
                                            <groupId>org.glowroot</groupId>
                                            <artifactId>glowroot</artifactId>
                                            <version>0.14.0-beta.3</version>
                                            <type>zip</type>
                                            <classifier>dist</classifier>
                                        </artifactItem>
                                    </artifactItems>
                                    <outputDirectory>
                                        ${project.build.directory}/glowroot
                                    </outputDirectory>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                    </plugin>
                    <plugin>
                        <groupId>com.google.cloud.tools</groupId>
                        <artifactId>jib-maven-plugin</artifactId>
                        <version>3.4.2</version>
                        <configuration>
                            <from>
                                <image>r-docker-registry-1-docker-io.artifactory.svc.elca.ch/eclipse-temurin:11-jre</image>
                            </from>
                            <to>
                                <image>prj-lagapep-docker.artifactory.svc.elca.ch/lagapep-app</image>
                                <tags>
                                    <tag>${containerImageVersion}</tag>
                                </tags>
                            </to>
                            <extraDirectories>
                                <paths>
                                    <path>
                                        <from>../openshift/glowroot</from>
                                        <into>/glowroot</into>
                                    </path>
                                    <path>
                                        <from>target/glowroot/glowroot</from>
                                        <into>/glowroot</into>
                                    </path>
                                </paths>
                            </extraDirectories>
                            <container>
                                <environment>
                                    <TZ>Europe/Zurich</TZ>
                                    <SERVER_PORT>8080</SERVER_PORT>
                                </environment>
                                <jvmFlags>
                                    <!-- For Hazelcast access to Java internal API -->
                                    <jvmFlag>--add-modules=java.se</jvmFlag>
                                    <jvmFlag>--add-exports=java.base/jdk.internal.ref=ALL-UNNAMED</jvmFlag>
                                    <jvmFlag>--add-opens=java.base/java.lang=ALL-UNNAMED</jvmFlag>
                                    <jvmFlag>--add-opens=java.base/java.nio=ALL-UNNAMED</jvmFlag>
                                    <jvmFlag>--add-opens=java.base/sun.nio.ch=ALL-UNNAMED</jvmFlag>
                                    <jvmFlag>--add-opens=java.management/sun.management=ALL-UNNAMED</jvmFlag>
                                    <jvmFlag>--add-opens=jdk.management/com.sun.management.internal=ALL-UNNAMED</jvmFlag>
                                    <jvmFlag>-Duser.language=fr</jvmFlag>
                                    <jvmFlag>-Duser.country=CH</jvmFlag>
                                </jvmFlags>
                                <ports>
                                    <port>8080</port>
                                    <port>4000</port>
                                </ports>
                            </container>
                            <allowInsecureRegistries>true</allowInsecureRegistries>
                        </configuration>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>Local</id>
            <properties>
                <app-packaging>jar</app-packaging>
                <start-class>ch.vd.formation.lagapep.LagapepApplication</start-class>
            </properties>
            <build>
                <resources>
                    <resource>
                        <directory>src/main/resources</directory>
                        <filtering>true</filtering>
                        <includes>
                            <include>application-local.yml</include>
                            <include>logging/logback-spring.xml</include>
                            <include>hotswap-agent.properties</include>
                        </includes>
                    </resource>
                </resources>

                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                    </plugin>
                </plugins>
            </build>
        </profile>

        <!-- ACV/DGNSI - Specific profiles for delivery -->
        <profile>
            <id>nexus</id>
            <properties>
                <assembly.finalName>${project.artifactId}-${project.version}</assembly.finalName>
                <app-packaging>jar</app-packaging>
            </properties>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>repackage</id>
                                <configuration>
                                    <executable>true</executable>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-assembly-plugin</artifactId>
                        <executions>
                            <execution>
                                <phase>package</phase>
                                <goals>
                                    <goal>single</goal>
                                </goals>
                            </execution>
                        </executions>
                        <configuration>
                            <descriptors>
                                <descriptor>assembly.xml</descriptor>
                            </descriptors>
                            <finalName>${assembly.finalName}</finalName>
                            <appendAssemblyId>false</appendAssemblyId>
                            <tarLongFileMode>posix</tarLongFileMode>
                        </configuration>
                    </plugin>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-install-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>default-install</id>
                                <phase>none</phase>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <artifactId>maven-clean-plugin</artifactId>
                        <executions>
                            <execution>
                                <!-- we can't override this id -->
                                <id>default-clean</id>
                                <phase>install</phase>
                                <goals>
                                    <goal>clean</goal>
                                </goals>
                                <configuration>
                                    <excludeDefaultDirectories>true</excludeDefaultDirectories>
                                    <filesets>
                                        <fileset>
                                            <directory>${project.build.directory}</directory>
                                            <excludes>
                                                <exclude>${assembly.finalName}.tar.gz</exclude>
                                            </excludes>
                                        </fileset>
                                    </filesets>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
            <distributionManagement>
                <repository>
                    <id>nexus-dgnsi-server</id>
                    <name>Nexus DGNSI</name>
                    <url>${nexus.url}/app-jenkinsdgnsi-stable</url>
                </repository>
                <snapshotRepository>
                    <id>nexus-dgnsi-server</id>
                    <name>Nexus DGNSI</name>
                    <url>${nexus.url}/app-jenkinsdgnsi-snapshots</url>
                    <uniqueVersion>false</uniqueVersion>
                </snapshotRepository>
            </distributionManagement>
        </profile>
        <profile>
            <id>devex.release</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>ch.vd.devex</groupId>
                        <artifactId>devex-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>create</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>create-release</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>devex.in</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>ch.vd.devex</groupId>
                        <artifactId>devex-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>deploy</id>
                                <phase>deploy</phase>
                                <goals>
                                    <goal>deploy</goal>
                                </goals>
                                <configuration>
                                    <environment>IN</environment>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>

    <build>
        <finalName>${executable.finalName}</finalName>
        <resources>
            <resource>
                <directory>src/main/resources</directory>
                <filtering>true</filtering>
                <excludes>
                    <exclude>application-local.yml</exclude>
                    <exclude>logging/logback-spring.xml</exclude>
                    <exclude>hotswap-agent.properties</exclude>
                </excludes>
            </resource>
        </resources>
        <plugins>
            <plugin>
                <groupId>org.openapitools</groupId>
                <artifactId>openapi-generator-maven-plugin</artifactId>
                <version>4.3.1</version>
                <executions>
                    <execution>
                        <id>app_rest_api</id>
                        <goals>
                            <goal>generate</goal>
                        </goals>
                        <configuration>
                            <inputSpec>
                                ${project.basedir}/src/main/resources/openapi/app_api.yaml
                            </inputSpec>
                            <generatorName>spring</generatorName>
                            <apiPackage>ch.vd.formation.lagapep.app.infrastructure.adapter.api</apiPackage>
                            <generateApis>true</generateApis>
                            <generateApiTests>false</generateApiTests>
                            <generateApiDocumentation>false</generateApiDocumentation>
                            <modelPackage>ch.vd.formation.lagapep.app.infrastructure.adapter.api.model</modelPackage>
                            <modelNameSuffix>ApiBean</modelNameSuffix>
                            <generateModels>true</generateModels>
                            <generateModelTests>false</generateModelTests>
                            <generateModelDocumentation>false</generateModelDocumentation>
                            <generateSupportingFiles>true</generateSupportingFiles>
                            <ignoreFileOverride>
                                ${project.basedir}/src/main/resources/openapi/.openapi-generator-ignore
                            </ignoreFileOverride>
                            <configOptions>
                                <dateLibrary>java8</dateLibrary>
                                <interfaceOnly>true</interfaceOnly>
                                <useBeanValidation>true</useBeanValidation>
                            </configOptions>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>